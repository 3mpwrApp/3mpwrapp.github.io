<!DOCTYPE html>
<html lang="{{ page.lang | default: 'en' }}"{% if page.lang == 'ar' %} dir="rtl"{% endif %}>
<head>
  <meta charset="UTF-8">
  <title>{{ page.title }} | {{ site.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="{{ page.description | default: site.description }}">
  
  <!-- 
    Security Headers: These should be set via server-side headers file (_headers for Netlify/Vercel, .htaccess for Apache, etc.)
    CSP meta tag is included above as the only valid http-equiv for security headers.
    X-Content-Type-Options, X-Frame-Options, and Referrer-Policy must be set as HTTP response headers, not meta tags.
  -->
  
  <!-- Resource Hints for Performance (limit to 3 most critical) -->
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
  <link rel="dns-prefetch" href="https://formspree.io">
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
  
  <!-- Preload critical resources -->
  <link rel="preload" href="{{ "/assets/css/style.min.css" | relative_url }}" as="style">
  <link rel="preload" href="{{ "/assets/css/design-system.min.css" | relative_url }}" as="style">
  <link rel="preload" href="{{ "/assets/empwrapp-logo.png" | relative_url }}" as="image">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="{{ "/manifest.json" | relative_url }}">
  
  {%- include meta-tags.html -%}
  {%- include structured-data.html -%}
  {%- include custom-head.html -%}
  {%- seo -%}
  <link rel="stylesheet" href="{{ "/assets/css/style.min.css" | relative_url }}">
  <!-- WCAG AAA Compliant Color System -->
  <link rel="stylesheet" href="{{ "/assets/css/accessibility-tokens.min.css" | relative_url }}">
  <!-- WCAG 2.2 AA and Beyond Accessibility Enhancements -->
  <link rel="stylesheet" href="{{ "/assets/css/accessibility-enhancements.min.css" | relative_url }}">
  <!-- Performance Optimizations: Critical CSS, Lazy Loading, Font Optimization -->
  <link rel="stylesheet" href="{{ "/assets/css/performance-optimizations.min.css" | relative_url }}">
  <!-- Lighthouse Audit Fixes: Touch targets, contrast, aspect ratios -->
  <link rel="stylesheet" href="{{ "/assets/css/lighthouse-fixes.min.css" | relative_url }}">
  <!-- Cookie Consent Banner (GDPR Compliance) -->
  <link rel="stylesheet" href="{{ "/assets/css/cookie-consent.css" | relative_url }}">

  <!-- Header/nav footprint overrides moved to external CSS (CSP-safe) -->
  <link rel="stylesheet" href="{{ "/assets/css/header-overrides.css" | relative_url }}">
  <!-- Professional polish & design system (UX/UI audit improvements) -->
  <link rel="stylesheet" href="{{ "/assets/css/professional-polish.css" | relative_url }}">
  <!-- CLS (Cumulative Layout Shift) Fix - Cloudflare RUM reported 0.351-0.588 CLS -->
  <link rel="stylesheet" href="{{ "/assets/css/cls-fix.css" | relative_url }}">
  <!-- Alignment Consistency Fix - Professional, clean, organized layout -->
  <link rel="stylesheet" href="{{ "/assets/css/alignment-consistency.css" | relative_url }}">
  <!-- Global UX/UI Consistency - Ensures professional, clean, organized look across all pages -->
  <link rel="stylesheet" href="{{ "/assets/css/global-consistency.css" | relative_url }}">
  <!-- Enhanced Focus Indicators - WCAG 2.2 AAA compliant (3:1 contrast, 2px minimum) -->
  <link rel="stylesheet" href="{{ "/assets/css/enhanced-focus-indicators.css" | relative_url }}">
</head>
<body>
  <a class="skip-link" href="#main-content">Skip to content</a>
  <a class="skip-link" href="#primary-nav">Skip to navigation</a>
  <a class="skip-link" href="#site-footer">Skip to footer</a>
  <header>
    <!-- Brand: clicking this takes you home -->
    <div class="brand header-bar">
      <a class="site-brand" href="{{ '/' | relative_url }}" aria-label="{{ site.title }} home">
        <picture>
          <source type="image/webp" srcset="{{ '/assets/empwrapp-logo.webp' | relative_url }}">
          <img src="{{ '/assets/empwrapp-logo.png' | relative_url }}" alt="" width="28" height="28" aria-hidden="true" loading="eager">
        </picture>
        <span>{{ site.title }}</span>
      </a>
      <button class="menu-toggle" type="button" aria-controls="primary-nav" aria-expanded="false">Menu</button>
  {%- assign current = page.url | default: '/' -%}
  {%- assign lang_code = page.lang | default: 'en' -%}
  {%- assign switch_to = site.data.locales[lang_code].switch_href -%}
  {%- if current == '/about/' -%}{% assign switch_to = '/fr/about/' %}{%- endif -%}
  {%- if current == '/fr/about/' -%}{% assign switch_to = '/about/' %}{%- endif -%}
  {%- if current == '/features/' -%}{% assign switch_to = '/fr/features/' %}{%- endif -%}
  {%- if current == '/fr/features/' -%}{% assign switch_to = '/features/' %}{%- endif -%}
  {%- if current == '/user-guide/' -%}{% assign switch_to = '/fr/user-guide/' %}{%- endif -%}
  {%- if current == '/fr/user-guide/' -%}{% assign switch_to = '/user-guide/' %}{%- endif -%}
  <a class="lang-switch" href="{{ switch_to | relative_url }}">{{ site.data.locales[lang_code].switch_label }}</a>
    </div>

  <nav id="primary-nav" aria-label="Primary">
      {% if page.lang == 'fr' %}{% assign lang_prefix = '/fr' %}{% else %}{% assign lang_prefix = '' %}{% endif %}
  <ul class="nav-list">
        <li>
          <a href="{{ lang_prefix | append: '/' | relative_url }}" {% if page.url == '/' or page.url == '/index.html' or page.url == '/fr/' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Accueil{% else %}Home{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/about' | relative_url }}" {% if page.url contains '/about' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Ã€ propos{% else %}About{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/features' | relative_url }}" {% if page.url contains '/features' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}FonctionnalitÃ©s{% else %}Features{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/user-guide' | relative_url }}" {% if page.url contains '/user-guide' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Guide d'utilisation{% else %}User Guide{% endif %}
          </a>
        </li>
        <li>
          <a href="{% if page.lang == 'fr' %}/roadmap{% else %}{{ lang_prefix | append: '/roadmap' | relative_url }}{% endif %}" {% if page.url contains '/roadmap' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Feuille de route{% else %}Roadmap{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/blog' | relative_url }}" {% if page.url contains '/blog' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Blog{% else %}Blog{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/faq' | relative_url }}" {% if page.url contains '/faq' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}FAQ{% else %}FAQ{% endif %}
          </a>
        </li>
        <li>
          <a href="{% if page.lang == 'fr' %}/accessibility{% else %}{{ lang_prefix | append: '/accessibility' | relative_url }}{% endif %}" {% if page.url contains '/accessibility' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}AccessibilitÃ©{% else %}Accessibility{% endif %}
          </a>
        </li>
        <li>
          <a href="{% if page.lang == 'fr' %}/app-waitlist{% else %}{{ lang_prefix | append: '/app-waitlist' | relative_url }}{% endif %}" {% if page.url contains '/app-waitlist' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Liste d'attente{% else %}App Waitlist{% endif %}
          </a>
        </li>
        <li>
          <a href="{% if page.lang == 'fr' %}/crisis-resources{% else %}{{ lang_prefix | append: '/crisis-resources' | relative_url }}{% endif %}" {% if page.url contains '/crisis-resources' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Ressources de crise{% else %}Crisis Help{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/contact' | relative_url }}" {% if page.url contains '/contact' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Contact{% else %}Contact{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/newsletter' | relative_url }}" {% if page.url contains '/newsletter' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Infolettre{% else %}Newsletter{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/whats-new' | relative_url }}" {% if page.url contains '/whats-new' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Quoi de neuf{% else %}What's New{% endif %}
          </a>
        </li>
        <li>
          <a href="{% if page.lang == 'fr' %}/beta-guide{% else %}{{ lang_prefix | append: '/beta-guide' | relative_url }}{% endif %}" {% if page.url contains '/beta' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Guide des testeurs bÃªta{% else %}Beta Testers Guide{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/search' | relative_url }}" {% if page.url contains '/search' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Recherche{% else %}Search{% endif %}
          </a>
        </li>
        <li>
          <a href="{% if page.lang == 'fr' %}/events{% else %}{{ lang_prefix | append: '/events' | relative_url }}{% endif %}" {% if page.url contains '/events' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Ã‰vÃ©nements{% else %}Events{% endif %}
          </a>
        </li>
        <li>
          <a href="{% if page.lang == 'fr' %}/site-map{% else %}{{ lang_prefix | append: '/site-map' | relative_url }}{% endif %}" {% if page.url contains '/site-map' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Plan du site{% else %}Site Map{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/accessibility-settings' | relative_url }}" {% if page.url contains '/accessibility-settings' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}ParamÃ¨tres d'accessibilitÃ©{% else %}Accessibility Settings{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/campaigns' | relative_url }}" {% if page.url contains '/campaigns' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Campagnes{% else %}Campaigns{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/community-spotlight' | relative_url }}" {% if page.url contains '/community-spotlight' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}CommunautÃ©{% else %}Community{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/connect' | relative_url }}" {% if page.url contains '/connect' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Connecter{% else %}Connect{% endif %}
          </a>
        </li>
      </ul>
    </nav>

    <!-- High contrast + Dark mode toggles -->
    <div class="header-controls" role="group" aria-label="Display settings">
      <button
        id="contrast-toggle"
        class="contrast-toggle"
        type="button"
        aria-pressed="false"
        aria-label="Toggle high contrast mode"
      >
        High contrast
      </button>

      <button
        id="theme-toggle"
        class="theme-toggle"
        type="button"
        aria-pressed="false"
        aria-label="Toggle dark mode"
      >
        Dark mode
      </button>
    </div>
  </header>

  {%- comment -%}
    Accessible breadcrumbs. Shows Home > Section > Page when the URL depth >= 2.
    Adjusts based on the current page URL segments.
  {%- endcomment -%}
  <nav aria-label="Breadcrumb" class="breadcrumbs">
    <ol>
      <li><a href="{{ '/' | relative_url }}">Home</a></li>
      {%- assign segments = page.url | split: '/' | where_exp: 's', 's != ""' -%}
      {%- if segments.size > 0 -%}
        {%- assign path = '' -%}
        {%- for seg in segments -%}
          {%- if seg == '' -%}{% continue %}{%- endif -%}
          {%- assign path = path | append: '/' | append: seg -%}
          {%- if forloop.last -%}
            <li aria-current="page">{{ page.title | default: seg | replace: '-', ' ' | capitalize }}</li>
          {%- else -%}
            {%- assign seg_label = seg | replace: '-', ' ' | capitalize -%}
            {%- if seg_label == '' -%}{% assign seg_label = 'Home' %}{%- endif -%}
            <li><a href="{{ path | relative_url }}">{{ seg_label }}</a></li>
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    </ol>
  </nav>

  <main id="main-content" tabindex="-1">
    {{ content }}
  </main>

  <footer id="site-footer">
    <div class="footer-grid">
      <!-- About Column -->
      <div class="footer-column">
        <h3>About</h3>
        <ul>
          <li><a href="{{ '/about' | relative_url }}">Our Mission</a></li>
          <li><a href="{{ '/user-guide' | relative_url }}">User Guide</a></li>
          <li><a href="{{ '/features' | relative_url }}">Features</a></li>
          <li><a href="{{ '/roadmap' | relative_url }}">Roadmap</a></li>
        </ul>
      </div>

      <!-- Get Started Column -->
      <div class="footer-column">
        <h3>Get Started</h3>
        <ul>
          <li><a href="{{ '/beta' | relative_url }}">Beta Testing</a></li>
          <li><a href="{{ '/faq' | relative_url }}">FAQ</a></li>
          <li><a href="{{ '/contact' | relative_url }}">Contact</a></li>
          <li><a href="{{ '/accessibility-walkthrough' | relative_url }}">Accessibility Guide</a></li>
        </ul>
      </div>

      <!-- Legal Column -->
      <div class="footer-column">
        <h3>Legal & Privacy</h3>
        <ul>
          <li><a href="{{ '/privacy' | relative_url }}">Privacy Policy</a></li>
          <li><a href="{{ '/terms' | relative_url }}">Terms of Service</a></li>
          <li><a href="{{ '/data-ownership' | relative_url }}">Data Ownership</a></li>
          <li><a href="{{ '/community/guidelines' | relative_url }}">Community Guidelines</a></li>
        </ul>
      </div>

      <!-- Support Column -->
      <div class="footer-column">
        <h3>Support</h3>
        <ul>
          <li><a href="{{ '/accessibility' | relative_url }}">Accessibility Statement</a></li>
          <li><a href="{{ '/accessibility-settings' | relative_url }}">Accessibility Settings</a></li>
          <li><a href="{{ '/site-map' | relative_url }}">Site Map</a></li>
          <li><a href="{{ '/delete-data' | relative_url }}">Delete My Data</a></li>
        </ul>
      </div>

      <!-- Connect Column -->
      <div class="footer-column">
        <h3>Connect</h3>
        <div class="footer-social">
          <a href="https://www.facebook.com/3mpowrapp/" target="_blank" rel="noopener noreferrer" aria-label="Facebook">{%- include social-icons.html name='facebook' -%}</a>
          <a href="https://www.facebook.com/groups/1848263672453552" target="_blank" rel="noopener noreferrer" aria-label="3mpwr App Hub Facebook Group">{%- include social-icons.html name='facebook' -%}</a>
          <a href="https://x.com/3mpowrapp0816" target="_blank" rel="noopener noreferrer" aria-label="X (Twitter)">{%- include social-icons.html name='x' -%}</a>
          <a href="https://www.instagram.com/3mpwrapp/" target="_blank" rel="noopener noreferrer" aria-label="Instagram">{%- include social-icons.html name='instagram' -%}</a>
          <a href="https://mastodon.social/@3mpwrApp" target="_blank" rel="me noopener noreferrer" aria-label="Mastodon">{%- include social-icons.html name='mastodon' -%}</a>
          <a href="https://bsky.app/profile/3mpwrapp.bsky.social" target="_blank" rel="noopener noreferrer" aria-label="Bluesky">{%- include social-icons.html name='bluesky' -%}</a>
        </div>
        <ul style="margin-top: 1rem;">
          <li><a href="{{ '/blog' | relative_url }}">Blog</a></li>
          <li><a href="{{ '/whats-new/feed.xml' | relative_url }}" rel="alternate" type="application/rss+xml">RSS Feed</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-bottom">
      <p>&copy; {{ site.time | date: '%Y' }} 3mpwrApp â€” Canada â€¢ <a href="mailto:empowrapp08162025@gmail.com">Contact Us</a></p>
      <p class="footer-mission">ðŸ’š Grassroots & Community-Funded â€¢ 100% Free Forever â€¢ Mission-Driven, Not Profit-Driven</p>
    </div>
  </footer>

  <!-- Skip link and mobile menu functionality -->
  <script src="{{ '/assets/js/skip-links.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/mobile-menu.js' | relative_url }}" defer></script>

  <!-- Utilities and controls -->
  <script src="{{ '/assets/js/a11y.min.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/contrast.min.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/theme.min.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/back-to-top.min.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/settings.min.js' | relative_url }}" defer></script>
  
  <!-- Innovative Accessibility Features - Low Priority -->
  <script src="{{ '/assets/js/accessibility-innovations.min.js' | relative_url }}" defer async></script>
  
  <!-- WCAG 2.2 AA+ Compliance Features -->
  <script src="{{ '/assets/js/wcag-compliance.min.js' | relative_url }}" defer></script>

  <!-- Cookie Consent (GDPR Compliance) - Load early to show banner -->
    <!-- Cookie Consent (GDPR Compliance) - Load early to show banner -->
  {%- comment -%}
    Cookie consent UI is provided inline below. Remove JS injector to avoid
    duplicate banners (it inserts a second banner with a different id).
  {%- endcomment -%}
  

  {%- if jekyll.environment == "production" -%}

  <script>
    // Mobile menu toggle accessibility
    (function(){
      var toggle = document.querySelector('.menu-toggle');
      var nav = document.getElementById('primary-nav');
      if (!toggle || !nav) return;
      function setOpen(open){
        nav.classList.toggle('is-open', !!open);
        toggle.setAttribute('aria-expanded', !!open);
        if (open) {
          // Move focus to first nav link
          var first = nav.querySelector('a, button, [tabindex]:not([tabindex="-1"])');
          if (first && first.focus) first.focus();
        } else {
          // Return focus to toggle
          if (toggle && toggle.focus) toggle.focus();
        }
      }
      toggle.addEventListener('click', function(){
        var open = nav.classList.contains('is-open');
        setOpen(!open);
      });
      // Close on ESC when open
      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape' && nav.classList.contains('is-open')) setOpen(false);
      });
      // Focus trap within nav when open
      document.addEventListener('keydown', function(e){
        if (!nav.classList.contains('is-open') || e.key !== 'Tab') return;
        var focusables = nav.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');
        focusables = Array.prototype.filter.call(focusables, function(el){ return el.offsetParent !== null; });
        if (focusables.length === 0) return;
        var first = focusables[0];
        var last = focusables[focusables.length - 1];
        var active = document.activeElement;
        if (e.shiftKey && (active === first || !nav.contains(active))) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && (active === last || !nav.contains(active))) {
          e.preventDefault();
          first.focus();
        }
      });
      // Close on click outside
      document.addEventListener('click', function(e){
        if (!nav.classList.contains('is-open')) return;
        var within = nav.contains(e.target) || toggle.contains(e.target);
        if (!within) setOpen(false);
      });
    })();
  </script>

  <!-- Cookie consent banner -->
  <div id="cookie-banner" class="cookie-banner" role="dialog" aria-labelledby="cookie-banner-title" aria-describedby="cookie-banner-desc" hidden>
    <div>
      <h2 id="cookie-banner-title" style="font-size: 1rem; margin: 0 0 0.5rem;">Cookie Preferences</h2>
      <p id="cookie-banner-desc" style="margin: 0 0 0.5rem;">We use cookies to improve your experience. <a href="{{ '/cookies/' | relative_url }}">Learn more</a>.</p>
      <details style="margin: 0.5rem 0;">
        <summary style="cursor: pointer; user-select: none;">Manage cookie settings</summary>
        <div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px;">
          <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.25rem 0;">
            <input type="checkbox" checked disabled aria-disabled="true">
            <span><strong>Essential cookies</strong> (required) - Necessary for the website to function</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.25rem 0;">
            <input type="checkbox" id="cookie-analytics-pref" aria-describedby="analytics-desc">
            <span><strong>Analytics cookies</strong> (optional) - Help us understand how visitors use our site</span>
          </label>
          <p id="analytics-desc" style="margin: 0.25rem 0 0 1.75rem; font-size: 0.85em; color: rgba(255,255,255,0.8);">
            We use privacy-friendly analytics with IP anonymization. No personal data is collected.
          </p>
        </div>
      </details>
    </div>
    <div class="cookie-actions">
      <button id="cookie-accept" type="button" class="button button--primary" aria-label="Accept all cookies">Accept all</button>
      <button id="cookie-custom" type="button" class="button" aria-label="Save cookie preferences">Save preferences</button>
      <button id="cookie-decline" type="button" class="button button--secondary" aria-label="Decline optional cookies">Decline optional</button>
    </div>
  </div>
  <script>
    (function(){
      var KEY = 'cookie-consent';
      var ANALYTICS_KEY = 'cookie-analytics';
      var storageMode = 'localStorage';
      function lsAvailable(){
        try { var t='__t'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return true; } catch(e){ return false; }
      }
      function cookieGet(k){
        var m=document.cookie.match(new RegExp('(?:^|; )'+k.replace(/([.$?*|{}()\[\]\\\/\+^])/g,'\\$1')+'=([^;]*)'));
        return m? decodeURIComponent(m[1]) : null;
      }
      function cookieSet(k,v,days){
        var exp='';
        if (days){ var d=new Date(); d.setTime(d.getTime()+days*864e5); exp='; expires='+d.toUTCString(); }
        document.cookie=k+'='+encodeURIComponent(v)+exp+'; path=/; SameSite=Lax';
      }
      var haveLS = lsAvailable();
      if (!haveLS) storageMode = 'cookie';
      function get(k){
        if (storageMode==='localStorage') return localStorage.getItem(k);
        return cookieGet(k);
      }
      function set(k,v){
        if (storageMode==='localStorage') { try { localStorage.setItem(k,v); } catch(e){} }
        else cookieSet(k,v,365);
      }
      var banner = document.getElementById('cookie-banner');
      var accept = document.getElementById('cookie-accept');
      var custom = document.getElementById('cookie-custom');
      var decline = document.getElementById('cookie-decline');
      var analyticsPref = document.getElementById('cookie-analytics-pref');
      if (!banner || !accept || !decline) return;
      
      // Show banner if no consent recorded
      if (!get(KEY)) { 
        banner.hidden = false;
        banner.setAttribute('aria-hidden', 'false');
      }
      
      // Load saved analytics preference
      if (analyticsPref) {
        analyticsPref.checked = get(ANALYTICS_KEY) === 'true';
      }
      
      function emit(status, analytics){ 
        try { 
          window.dispatchEvent(new CustomEvent('cookie-consent', { 
            detail: { 
              status: status,
              analytics: analytics 
            } 
          })); 
        } catch(e){} 
      }
      
      function closeBanner(status, analytics) {
        set(KEY, status);
        set(ANALYTICS_KEY, analytics.toString());
        // Mirror into cookies if using localStorage so server/other scripts can read (lightweight)
        if (storageMode==='localStorage') {
          try { document.cookie = KEY + '=' + encodeURIComponent(status) + '; path=/; SameSite=Lax;'; } catch(e){}
          try { document.cookie = ANALYTICS_KEY + '=' + encodeURIComponent(analytics.toString()) + '; path=/; SameSite=Lax;'; } catch(e){}
        }
        banner.hidden = true;
        banner.style.display = 'none';
        banner.setAttribute('aria-hidden', 'true');
        emit(status, analytics);
        if (window.announce) {
          window.announce('Cookie preferences saved: ' + (analytics ? 'All cookies accepted' : 'Only essential cookies'));
        }
      }
      
      accept.addEventListener('click', function(){ 
        closeBanner('accepted', true);
      });
      
      if (custom) {
        custom.addEventListener('click', function(){
          var analyticsEnabled = analyticsPref ? analyticsPref.checked : false;
          closeBanner('custom', analyticsEnabled);
        });
      }
      
      decline.addEventListener('click', function(){ 
        closeBanner('declined', false);
      });
      if (!haveLS) {
        console.log('[cookie-consent] localStorage unavailable, using cookies fallback');
      }
    })();
  </script>

  <!-- Newsletter modal (homepage only) -->
  <div id="newsletter-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="newsletter-title" aria-describedby="newsletter-description" hidden>
    <div class="modal-dialog newsletter-dialog" data-newsletter-dialog>
      <div class="modal-header">
        <h2 id="newsletter-title">Subscribe to our newsletter</h2>
        <p id="newsletter-description" class="sr-only">
          Get updates and news about 3mpwrApp. You can unsubscribe anytime. Form will open in a new window if needed.
        </p>
        <div class="modal-actions">
          <a class="modal-link" href="https://docs.google.com/forms/d/e/1FAIpQLSfuItjmtWlUW3L8irmSe8QN129_GJDLAF4f5n-QHPcj_FFoyg/viewform" target="_blank" rel="noopener noreferrer">Open form in new tab</a>
          <button id="newsletter-close" data-action="newsletter-close" type="button" aria-label="Close newsletter dialog" class="modal-close">Ã—</button>
        </div>
      </div>
      <div class="modal-body">
        <iframe
          title="3mpwrApp Newsletter Signup"
          src="https://docs.google.com/forms/d/e/1FAIpQLSfuItjmtWlUW3L8irmSe8QN129_GJDLAF4f5n-QHPcj_FFoyg/viewform?embedded=true"
          class="modal-iframe"
          loading="lazy"
        ></iframe>
      </div>
      <div class="modal-footer">
        <label style="display:flex;align-items:center;gap:0.5rem;">
          <input type="checkbox" id="newsletter-dontshow" />
          Donâ€™t show again
        </label>
        <div class="modal-buttons">
          <button id="newsletter-dismiss" data-action="newsletter-dismiss" type="button" class="button button--secondary">Not now</button>
          <button id="newsletter-subscribed" data-action="newsletter-subscribed" type="button" class="button">Already subscribed</button>
          <button id="newsletter-done" data-action="newsletter-done" type="button" class="button button--primary">Done, go home</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
  var MODAL_KEY = 'newsletter-dismissed'; // legacy key (kept for compatibility)
  var MODAL_SEEN = 'newsletter-seen'; // first-visit gating
  var MODAL_SUB = 'newsletter-subscribed';
  var modal = document.getElementById('newsletter-modal');
  var closeBtn = document.getElementById('newsletter-close');
  var dismissBtn = document.getElementById('newsletter-dismiss');
  var subscribedBtn = document.getElementById('newsletter-subscribed');
  var dialog = modal ? modal.querySelector('[data-newsletter-dialog]') : null;
  var dontShow = document.getElementById('newsletter-dontshow');
  var homeRoot = '{{ '/' | relative_url }}';
      var isHome = (location.pathname === homeRoot || location.pathname === homeRoot + 'index.html');
  var noModal = (new URLSearchParams(location.search)).get('no-modal') === '1';

      function safeSet(key, val) {
        try { localStorage.setItem(key, val); } catch (e) { /* ignore */ }
      }
      function safeGet(key) {
        try { return localStorage.getItem(key); } catch (e) { return null; }
      }

      function closeModal() {
        if (!modal) return;
        modal.hidden = true;
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');
        if (window.announce) {
          window.announce('Newsletter dialog closed');
        }
      }

      function openModal() {
        if (!modal) return;
        modal.hidden = false;
        modal.classList.add('is-open');
        modal.removeAttribute('aria-hidden');
        document.body.classList.add('no-scroll');
        // Focus the dialog for a11y
        if (dialog && dialog.focus) dialog.setAttribute('tabindex','-1'), dialog.focus();
        if (window.announce) {
          window.announce('Newsletter dialog opened');
        }
      }

      function shouldShow() {
        if (safeGet(MODAL_SUB) === '1') return false; // already subscribed
        if (safeGet(MODAL_SEEN) === '1') return false; // first-visit only
        return true;
      }

      // Newsletter popup disabled - users can access via newsletter link in footer
      // if (modal && isHome && !noModal && shouldShow()) {
      //   setTimeout(openModal, 400);
      // }

      function handleDismiss() {
        safeSet(MODAL_KEY, '1'); // legacy
        if (dontShow && dontShow.checked) {
          safeSet(MODAL_SEEN, '1');
        }
        closeModal();
      }

  [closeBtn, dismissBtn].forEach(function(btn){ if (btn) btn.addEventListener('click', handleDismiss); });

      var doneBtn = document.getElementById('newsletter-done');
      if (doneBtn) {
        doneBtn.addEventListener('click', function(){
          handleDismiss();
          safeSet(MODAL_SEEN, '1');
          // Ensure we land on home
          try { window.location.assign(homeRoot); } catch(e) {}
        });
      }

      if (subscribedBtn) {
        subscribedBtn.addEventListener('click', function(){
          safeSet(MODAL_SUB, '1');
          safeSet(MODAL_SEEN, '1');
          closeModal();
        });
      }

      // Delegated click handling using data-action for broader compatibility
      document.addEventListener('click', function(e){
        var t = e.target;
        if (!t) return;
        var action = t.getAttribute && t.getAttribute('data-action');
        if (!action && t.closest) {
          var closest = t.closest('[data-action]');
          if (closest) action = closest.getAttribute('data-action');
        }
        if (!action) return;
        if (action === 'newsletter-close' || action === 'newsletter-dismiss') {
          handleDismiss();
        } else if (action === 'newsletter-subscribed') {
          safeSet(MODAL_SUB, '1');
          safeSet(MODAL_SEEN, '1');
          closeModal();
        } else if (action === 'newsletter-done') {
          handleDismiss();
          try { window.location.assign(homeRoot); } catch(e) {}
        }
      }, true);

      // Close on ESC and trap focus while open
      document.addEventListener('keydown', function(e){
        if (!modal || modal.hidden) return;
        if (e.key === 'Escape') {
          safeSet(MODAL_KEY, '1');
          if (dontShow && dontShow.checked) safeSet(MODAL_SEEN, '1');
          closeModal();
          return;
        }
        if (e.key === 'Tab') {
          var focusables = dialog ? dialog.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])') : [];
          focusables = Array.prototype.slice.call(focusables).filter(function(el){ return el.offsetParent !== null; });
          if (focusables.length === 0) return;
          var first = focusables[0];
          var last = focusables[focusables.length - 1];
          var active = document.activeElement;
          if (e.shiftKey) {
            if (active === first || !dialog.contains(active)) {
              e.preventDefault();
              last.focus();
            }
          } else {
            if (active === last || !dialog.contains(active)) {
              e.preventDefault();
              first.focus();
            }
          }
        }
      }, true);

      // Close on backdrop click (but not when clicking inside dialog)
      if (modal) {
        modal.addEventListener('click', function(e){
          if (e.target === modal) {
            safeSet(MODAL_KEY, '1');
            if (dontShow && dontShow.checked) safeSet(MODAL_SEEN, '1');
            closeModal();
          }
        });
      }

      // Optional: if Google Form redirects back, auto-dismiss next visit
      if (document.referrer && document.referrer.includes('docs.google.com/forms')) {
        safeSet(MODAL_KEY, '1');
        safeSet(MODAL_SEEN, '1');
      }
    })();
  </script>

  <!-- Back to top button -->
  <button
    id="back-to-top"
    class="back-to-top"
    type="button"
    aria-label="Back to top"
    aria-hidden="true"
    tabindex="-1"
  >
    â†‘ Back to top
  </button>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('{{ "/sw.js" | relative_url }}')
          .then(function(registration) {
            console.log('[SW] Registration successful:', registration.scope);
            
            // Check for updates every hour
            setInterval(function() {
              registration.update();
            }, 3600000);
            
            // Show update notification when new service worker is waiting
            registration.addEventListener('updatefound', function() {
              var newWorker = registration.installing;
              if (!newWorker) return;
              
              newWorker.addEventListener('statechange', function() {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New service worker available
                  if (confirm('A new version of 3mpwrApp is available! Reload to update?')) {
                    newWorker.postMessage({ action: 'skipWaiting' });
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch(function(error) {
            console.log('[SW] Registration failed:', error);
          });
        
        // Auto-reload when new service worker takes control
        var refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', function() {
          if (refreshing) return;
          refreshing = true;
          window.location.reload();
        });
      });
    }
  </script>

  <!-- Lazy Loading Script -->
  <script src="{{ "/assets/js/lazy-load.min.js" | relative_url }}" defer></script>

  <!-- Performance Monitoring (development only - disable in production if needed) -->
  <script src="{{ "/assets/js/performance-monitor.min.js" | relative_url }}" defer></script>

  {%- endif -%}

  <!-- Cloudflare Web Analytics -->
  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "fef378cf7f9742c582f28f566e204a85"}'></script>
  <!-- End Cloudflare Web Analytics -->
</body>
</html>
