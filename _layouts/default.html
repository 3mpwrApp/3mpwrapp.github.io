<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ page.title }} | {{ site.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="{{ page.description | default: site.description }}">
  {%- include custom-head.html -%}
  {%- seo -%}
  <link rel="stylesheet" href="{{ "/assets/css/style.css" | relative_url }}">
</head>
<body>
  <a class="skip-link" href="#main-content">Skip to content</a>
  <a class="skip-link" href="#site-footer">Skip to footer</a>
  <header>
    <!-- Brand: clicking this takes you home -->
    <div class="brand">
      <a class="site-brand" href="{{ '/' | relative_url }}" aria-label="{{ site.title }} home">
        <img src="{{ '/assets/empowrapp-logo.png' | relative_url }}" alt="" width="28" height="28" aria-hidden="true" />
        <span>{{ site.title }}</span>
      </a>
    </div>

    <nav aria-label="Primary">
      <ul class="nav-list">
        <li>
          <a href="{{ '/' | relative_url }}" {% if page.url == '/' or page.url == '/index.html' %}aria-current="page"{% endif %}>Home</a>
        </li>
        <li>
          <a href="{{ '/about' | relative_url }}" {% if page.url == '/about.html' or page.url == '/about/' %}aria-current="page"{% endif %}>About</a>
        </li>
        <li>
          <a href="{{ '/features' | relative_url }}" {% if page.url contains '/features' %}aria-current="page"{% endif %}>Features</a>
        </li>
        <li>
          <a href="{{ '/user-guide' | relative_url }}" {% if page.url contains '/user-guide' %}aria-current="page"{% endif %}>User Guide</a>
        </li>
        <li>
          <a href="{{ '/contact' | relative_url }}" {% if page.url contains '/contact' %}aria-current="page"{% endif %}>Contact</a>
        </li>
        <li>
          <a href="{{ '/blog' | relative_url }}" {% if page.url contains '/blog' %}aria-current="page"{% endif %}>Blog</a>
        </li>
        <li>
          <a href="{{ '/newsletter' | relative_url }}" {% if page.url contains '/newsletter' %}aria-current="page"{% endif %}>Newsletter</a>
        </li>
        <li>
          <a href="{{ '/whats-new' | relative_url }}" {% if page.url contains '/whats-new' %}aria-current="page"{% endif %}>What's New</a>
        </li>
        <li>
          <a href="{{ '/beta' | relative_url }}" {% if page.url contains '/beta' %}aria-current="page"{% endif %}>Beta Test</a>
        </li>
        <li>
          <a href="{{ '/search' | relative_url }}" {% if page.url contains '/search' %}aria-current="page"{% endif %}>Search</a>
        </li>
      </ul>
    </nav>

    <!-- High contrast + Dark mode toggles -->
    <div class="header-controls" role="group" aria-label="Display settings">
      <button
        id="contrast-toggle"
        class="contrast-toggle"
        type="button"
        aria-pressed="false"
        aria-label="Toggle high contrast mode"
      >
        High contrast
      </button>

      <button
        id="theme-toggle"
        class="theme-toggle"
        type="button"
        aria-pressed="false"
        aria-label="Toggle dark mode"
      >
        Dark mode
      </button>
    </div>
  </header>

  <main id="main-content" role="main" tabindex="-1">
    {{ content }}
  </main>

  <footer id="site-footer">
    <div class="social-links">
      <a href="https://www.facebook.com/3mpowrapp" target="_blank" rel="noopener noreferrer">Facebook</a>
  <a href="https://x.com/3mpowrApp0816" target="_blank" rel="noopener noreferrer">X (Twitter)</a>
      <a href="https://www.instagram.com/3mpowrapp/" target="_blank" rel="noopener noreferrer">Instagram</a>
      <a href="{{ '/feed.xml' | relative_url }}" rel="alternate" type="application/rss+xml" aria-label="Subscribe to RSS feed">RSS</a>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLScY599ZYJtpRakd421ADGZumejk2WjmbVvpUknw2uHAzTNx9A/viewform?usp=header" target="_blank" rel="noopener noreferrer">Beta Testers Sign Up</a>
    </div>
  <p>&copy; {{ site.time | date: '%Y' }} <a href="{{ '/' | relative_url }}">3mpowr App</a> • <a href="{{ '/privacy/' | relative_url }}">Privacy</a> • <a href="{{ '/accessibility' | relative_url }}">Accessibility</a></p>
  </footer>

  <!-- A11y: skip link should move focus to main -->
  <script>
    (function() {
      var skip = document.querySelector('.skip-link');
      var main = document.getElementById('main-content');
      if (skip && main) {
        skip.addEventListener('click', function() {
          setTimeout(function(){ main.focus(); }, 0);
        });
      }
    })();
  </script>

  <!-- Utilities and controls -->
  <script src="{{ '/assets/js/a11y.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/contrast.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/theme.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/back-to-top.js' | relative_url }}" defer></script>

  <!-- Newsletter modal (homepage only) -->
  <div id="newsletter-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="newsletter-title" hidden>
    <div class="modal-dialog newsletter-dialog" data-newsletter-dialog>
      <div class="modal-header">
        <h2 id="newsletter-title">Subscribe to our newsletter</h2>
        <div class="modal-actions">
          <a class="modal-link" href="https://docs.google.com/forms/d/e/1FAIpQLSfuItjmtWlUW3L8irmSe8QN129_GJDLAF4f5n-QHPcj_FFoyg/viewform" target="_blank" rel="noopener noreferrer">Open form in new tab</a>
          <button id="newsletter-close" data-action="newsletter-close" type="button" aria-label="Close" class="modal-close">×</button>
        </div>
      </div>
      <div class="modal-body">
        <iframe
          title="3mpowrApp Newsletter Signup"
          src="https://docs.google.com/forms/d/e/1FAIpQLSfuItjmtWlUW3L8irmSe8QN129_GJDLAF4f5n-QHPcj_FFoyg/viewform?embedded=true"
          class="modal-iframe"
          loading="lazy"
        >Loading…</iframe>
      </div>
      <div class="modal-footer">
        <div class="reminder">
          <label for="newsletter-remind">Remind me in:</label>
          <select id="newsletter-remind" aria-label="Reminder interval">
            <option value="604800000" selected>1 week</option>
            <option value="1209600000">2 weeks</option>
            <option value="2592000000">1 month</option>
          </select>
        </div>
        <div class="modal-buttons">
          <button id="newsletter-dismiss" data-action="newsletter-dismiss" type="button" class="button button--secondary">Not now</button>
          <button id="newsletter-subscribed" data-action="newsletter-subscribed" type="button" class="button">Already subscribed</button>
          <button id="newsletter-done" data-action="newsletter-done" type="button" class="button button--primary">Done, go home</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
  var MODAL_KEY = 'newsletter-dismissed'; // legacy key (kept for compatibility)
  var MODAL_LAST = 'newsletter-last-dismissed';
  var MODAL_SUB = 'newsletter-subscribed';
  var modal = document.getElementById('newsletter-modal');
  var closeBtn = document.getElementById('newsletter-close');
  var dismissBtn = document.getElementById('newsletter-dismiss');
  var subscribedBtn = document.getElementById('newsletter-subscribed');
  var dialog = modal ? modal.querySelector('[data-newsletter-dialog]') : null;
  var reminderSelect = document.getElementById('newsletter-remind');
  var REM_MS = 'newsletter-reminder-ms';
  var homeRoot = '{{ '/' | relative_url }}';
      var isHome = (location.pathname === homeRoot || location.pathname === homeRoot + 'index.html');
  var noModal = (new URLSearchParams(location.search)).get('no-modal') === '1';

      function safeSet(key, val) {
        try { localStorage.setItem(key, val); } catch (e) { /* ignore */ }
      }
      function safeGet(key) {
        try { return localStorage.getItem(key); } catch (e) { return null; }
      }

      function closeModal() {
        if (!modal) return;
        modal.hidden = true;
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');
      }

      function openModal() {
        if (!modal) return;
        modal.hidden = false;
        modal.classList.add('is-open');
        modal.removeAttribute('aria-hidden');
        document.body.classList.add('no-scroll');
        // Focus the dialog for a11y
        if (dialog && dialog.focus) dialog.setAttribute('tabindex','-1'), dialog.focus();
      }

      function shouldShow() {
        if (safeGet(MODAL_SUB) === '1') return false; // user said they're subscribed
        var last = parseInt(safeGet(MODAL_LAST) || '0', 10);
        if (!last) return true;
        var WEEK = 7 * 24 * 60 * 60 * 1000;
        var interval = parseInt(safeGet(REM_MS) || String(WEEK), 10);
        if (!isFinite(interval) || interval < 24*60*60*1000) interval = WEEK; // min 1 day safeguard
        return (Date.now() - last) > interval;
      }

      if (modal && isHome && !noModal && shouldShow()) {
        // Show after a tiny delay so content is visible behind
        setTimeout(openModal, 400);
      }

      function handleDismiss() {
        safeSet(MODAL_KEY, '1'); // legacy
        var interval = null;
        if (reminderSelect && reminderSelect.value) {
          var v = parseInt(reminderSelect.value, 10);
          if (isFinite(v)) interval = v;
        }
        if (interval) safeSet(REM_MS, String(interval));
        safeSet(MODAL_LAST, String(Date.now()));
        closeModal();
      }

  [closeBtn, dismissBtn].forEach(function(btn){ if (btn) btn.addEventListener('click', handleDismiss); });

      var doneBtn = document.getElementById('newsletter-done');
      if (doneBtn) {
        doneBtn.addEventListener('click', function(){
          handleDismiss();
          // Ensure we land on home
          try { window.location.assign(homeRoot); } catch(e) {}
        });
      }

      if (subscribedBtn) {
        subscribedBtn.addEventListener('click', function(){
          safeSet(MODAL_SUB, '1');
          safeSet(MODAL_LAST, String(Date.now()));
          closeModal();
        });
      }

      // Delegated click handling using data-action for broader compatibility
      document.addEventListener('click', function(e){
        var t = e.target;
        if (!t) return;
        var action = t.getAttribute && t.getAttribute('data-action');
        if (!action && t.closest) {
          var closest = t.closest('[data-action]');
          if (closest) action = closest.getAttribute('data-action');
        }
        if (!action) return;
        if (action === 'newsletter-close' || action === 'newsletter-dismiss') {
          handleDismiss();
        } else if (action === 'newsletter-subscribed') {
          safeSet(MODAL_SUB, '1');
          safeSet(MODAL_LAST, String(Date.now()));
          closeModal();
        } else if (action === 'newsletter-done') {
          handleDismiss();
          try { window.location.assign(homeRoot); } catch(e) {}
        }
      }, true);

      // Close on ESC and trap focus while open
      document.addEventListener('keydown', function(e){
        if (!modal || modal.hidden) return;
        if (e.key === 'Escape') {
          safeSet(MODAL_KEY, '1');
          safeSet(MODAL_LAST, String(Date.now()));
          closeModal();
          return;
        }
        if (e.key === 'Tab') {
          var focusables = dialog ? dialog.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])') : [];
          focusables = Array.prototype.slice.call(focusables).filter(function(el){ return el.offsetParent !== null; });
          if (focusables.length === 0) return;
          var first = focusables[0];
          var last = focusables[focusables.length - 1];
          var active = document.activeElement;
          if (e.shiftKey) {
            if (active === first || !dialog.contains(active)) {
              e.preventDefault();
              last.focus();
            }
          } else {
            if (active === last || !dialog.contains(active)) {
              e.preventDefault();
              first.focus();
            }
          }
        }
      }, true);

      // Close on backdrop click (but not when clicking inside dialog)
      if (modal) {
        modal.addEventListener('click', function(e){
          if (e.target === modal) {
            safeSet(MODAL_KEY, '1');
            safeSet(MODAL_LAST, String(Date.now()));
            closeModal();
          }
        });
      }

      // Optional: if Google Form redirects back, auto-dismiss next visit
      if (document.referrer && document.referrer.includes('docs.google.com/forms')) {
        safeSet(MODAL_KEY, '1');
        safeSet(MODAL_LAST, String(Date.now()));
      }
    })();
  </script>

  <!-- Back to top button -->
  <button
    id="back-to-top"
    class="back-to-top"
    type="button"
    aria-label="Back to top"
    aria-hidden="true"
    tabindex="-1"
  >
    ↑ Back to top
  </button>
</body>
</html>
