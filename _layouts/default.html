<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ page.title }} | {{ site.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="{{ page.description | default: site.description }}">
  {%- include custom-head.html -%}
  {%- seo -%}
  <link rel="stylesheet" href="{{ "/assets/css/style.css" | relative_url }}">
</head>
<body>
  <a class="skip-link" href="#main-content">Skip to content</a>
  <header>
    <!-- Brand: clicking this takes you home -->
    <div class="brand">
      <a class="site-brand" href="{{ '/' | relative_url }}" aria-label="{{ site.title }} home" style="display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border:2px solid currentColor;border-radius:.5rem;text-decoration:none;font-weight:700">
        <img src="{{ '/assets/empowrapp-logo.png' | relative_url }}" alt="" width="28" height="28" style="display:inline-block" />
        <span>{{ site.title }}</span>
      </a>
    </div>

    <nav aria-label="Primary">
      <ul class="nav-list">
        <li>
          <a href="{{ '/' | relative_url }}" {% if page.url == '/' %}aria-current="page"{% endif %}>Home</a>
        </li>
        <li>
          <a href="{{ '/about' | relative_url }}" {% if page.url == '/about.html' or page.url == '/about/' %}aria-current="page"{% endif %}>About</a>
        </li>
        <li>
          <a href="{{ '/features' | relative_url }}" {% if page.url contains '/features' %}aria-current="page"{% endif %}>Features</a>
        </li>
        <li>
          <a href="{{ '/user-guide' | relative_url }}" {% if page.url contains '/user-guide' %}aria-current="page"{% endif %}>User Guide</a>
        </li>
        <li>
          <a href="{{ '/contact' | relative_url }}" {% if page.url contains '/contact' %}aria-current="page"{% endif %}>Contact</a>
        </li>
        <li>
          <a href="{{ '/blog' | relative_url }}" {% if page.url contains '/blog' %}aria-current="page"{% endif %}>Blog</a>
        </li>
        <li>
          <a href="{{ '/newsletter' | relative_url }}" {% if page.url contains '/newsletter' %}aria-current="page"{% endif %}>Newsletter</a>
        </li>
        <li>
          <a href="{{ '/beta' | relative_url }}" {% if page.url contains '/beta' %}aria-current="page"{% endif %}>Beta Test</a>
        </li>
        <li>
          <a href="{{ '/search' | relative_url }}" {% if page.url contains '/search' %}aria-current="page"{% endif %}>Search</a>
        </li>
      </ul>
    </nav>

    <!-- High contrast + Dark mode toggles -->
    <div class="header-controls" role="group" aria-label="Display settings">
      <button
        id="contrast-toggle"
        class="contrast-toggle"
        type="button"
        aria-pressed="false"
        aria-label="Toggle high contrast mode"
      >
        High contrast
      </button>

      <button
        id="theme-toggle"
        class="theme-toggle"
        type="button"
        aria-pressed="false"
        aria-label="Toggle dark mode"
      >
        Dark mode
      </button>
    </div>
  </header>

  <main id="main-content" role="main" tabindex="-1">
    {{ content }}
  </main>

  <footer>
    <div class="social-links">
      <a href="https://www.facebook.com/3mpowrapp" target="_blank" rel="noopener noreferrer">Facebook</a>
  <a href="https://x.com/3mpowrApp0816" target="_blank" rel="noopener noreferrer">X (Twitter)</a>
      <a href="https://www.instagram.com/3mpowrapp/" target="_blank" rel="noopener noreferrer">Instagram</a>
      <a href="{{ '/feed.xml' | relative_url }}" rel="alternate" type="application/rss+xml" aria-label="Subscribe to RSS feed">RSS</a>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLScY599ZYJtpRakd421ADGZumejk2WjmbVvpUknw2uHAzTNx9A/viewform?usp=header" target="_blank" rel="noopener noreferrer">Beta Testers Sign Up</a>
    </div>
  <p>&copy; {{ site.time | date: '%Y' }} <a href="{{ '/' | relative_url }}">3mpowr App</a> • <a href="{{ '/privacy/' | relative_url }}">Privacy</a></p>
  </footer>

  <!-- A11y: skip link should move focus to main -->
  <script>
    (function() {
      var skip = document.querySelector('.skip-link');
      var main = document.getElementById('main-content');
      if (skip && main) {
        skip.addEventListener('click', function() {
          setTimeout(function(){ main.focus(); }, 0);
        });
      }
    })();
  </script>

  <!-- Utilities and controls -->
  <script src="{{ '/assets/js/a11y.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/contrast.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/theme.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/back-to-top.js' | relative_url }}" defer></script>

  <!-- Newsletter modal (homepage only) -->
  <div id="newsletter-modal" role="dialog" aria-modal="true" aria-labelledby="newsletter-title" hidden style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:1000;padding:1rem;">
    <div data-newsletter-dialog style="max-width:640px;width:100%;background:#fff;color:#111;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;border-bottom:1px solid #eee;gap:.75rem">
        <h2 id="newsletter-title" style="margin:0;font-size:1.25rem">Subscribe to our newsletter</h2>
        <div style="display:flex;align-items:center;gap:.5rem">
          <a href="https://docs.google.com/forms/d/e/1FAIpQLSfuItjmtWlUW3L8irmSe8QN129_GJDLAF4f5n-QHPcj_FFoyg/viewform" target="_blank" rel="noopener noreferrer" style="font-size:.875rem;text-decoration:underline;">Open form in new tab</a>
          <button id="newsletter-close" type="button" aria-label="Close" style="border:0;background:transparent;font-size:1.25rem;line-height:1;cursor:pointer">×</button>
        </div>
      </div>
      <div style="padding:0;">
        <iframe
          title="3mpowrApp Newsletter Signup"
          src="https://docs.google.com/forms/d/e/1FAIpQLSfuItjmtWlUW3L8irmSe8QN129_GJDLAF4f5n-QHPcj_FFoyg/viewform?embedded=true"
          style="width:100%;height:70vh;border:0"
          loading="lazy"
        >Loading…</iframe>
      </div>
      <div style="padding:0.75rem 1.25rem;border-top:1px solid #eee;display:flex;gap:.5rem;justify-content:flex-end">
        <button id="newsletter-dismiss" type="button" class="button" style="padding:.5rem .75rem;border:1px solid #ccc;border-radius:.375rem;background:#f6f6f6;cursor:pointer">Not now</button>
        <button id="newsletter-done" type="button" class="button" style="padding:.5rem .75rem;border:1px solid #ccc;border-radius:.375rem;background:#e9f5ff;cursor:pointer">Done, go home</button>
      </div>
    </div>
  </div>

  <script>
    (function() {
  var MODAL_KEY = 'newsletter-dismissed'; // legacy key (kept for compatibility)
  var MODAL_LAST = 'newsletter-last-dismissed';
  var MODAL_SUB = 'newsletter-subscribed';
  var modal = document.getElementById('newsletter-modal');
  var closeBtn = document.getElementById('newsletter-close');
  var dismissBtn = document.getElementById('newsletter-dismiss');
  var dialog = modal ? modal.querySelector('[data-newsletter-dialog]') : null;
      var homeRoot = '{{ '/' | relative_url }}';
      var isHome = (location.pathname === homeRoot || location.pathname === homeRoot + 'index.html');

      function safeSet(key, val) {
        try { localStorage.setItem(key, val); } catch (e) { /* ignore */ }
      }
      function safeGet(key) {
        try { return localStorage.getItem(key); } catch (e) { return null; }
      }

      function closeModal() {
        if (!modal) return;
        modal.hidden = true;
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
      }

      function openModal() {
        if (!modal) return;
        modal.hidden = false;
        modal.style.display = 'flex';
        modal.removeAttribute('aria-hidden');
        document.body.style.overflow = 'hidden';
        // Focus the dialog for a11y
        if (dialog && dialog.focus) dialog.setAttribute('tabindex','-1'), dialog.focus();
      }

      function shouldShow() {
        if (safeGet(MODAL_SUB) === '1') return false; // user said they're subscribed
        var last = parseInt(safeGet(MODAL_LAST) || '0', 10);
        if (!last) return true;
        var WEEK = 7 * 24 * 60 * 60 * 1000;
        return (Date.now() - last) > WEEK;
      }

      if (modal && isHome && shouldShow()) {
        // Show after a tiny delay so content is visible behind
        setTimeout(openModal, 400);
      }

      function handleDismiss() {
        safeSet(MODAL_KEY, '1'); // legacy
        safeSet(MODAL_LAST, String(Date.now()));
        closeModal();
      }

      [closeBtn, dismissBtn].forEach(function(btn){ if (btn) btn.addEventListener('click', handleDismiss); });

      var doneBtn = document.getElementById('newsletter-done');
      if (doneBtn) {
        doneBtn.addEventListener('click', function(){
          handleDismiss();
          // Ensure we land on home
          try { window.location.assign(homeRoot); } catch(e) {}
        });
      }

      // Delegation fallback (in case elements are replaced dynamically)
      document.addEventListener('click', function(e){
        var t = e.target;
        if (!t) return;
        if (t.id === 'newsletter-close' || t.id === 'newsletter-dismiss') {
          handleDismiss();
        } else if (t.id === 'newsletter-done') {
          handleDismiss();
          try { window.location.assign(homeRoot); } catch(e) {}
        }
      }, true);

      // Close on ESC and trap focus while open
      document.addEventListener('keydown', function(e){
        if (!modal || modal.hidden) return;
        if (e.key === 'Escape') {
          safeSet(MODAL_KEY, '1');
          closeModal();
          return;
        }
        if (e.key === 'Tab') {
          var focusables = dialog ? dialog.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])') : [];
          focusables = Array.prototype.slice.call(focusables).filter(function(el){ return el.offsetParent !== null; });
          if (focusables.length === 0) return;
          var first = focusables[0];
          var last = focusables[focusables.length - 1];
          var active = document.activeElement;
          if (e.shiftKey) {
            if (active === first || !dialog.contains(active)) {
              e.preventDefault();
              last.focus();
            }
          } else {
            if (active === last || !dialog.contains(active)) {
              e.preventDefault();
              first.focus();
            }
          }
        }
      }, true);

      // Close on backdrop click (but not when clicking inside dialog)
      if (modal) {
        modal.addEventListener('click', function(e){
          if (e.target === modal) {
            safeSet(MODAL_KEY, '1');
            safeSet(MODAL_LAST, String(Date.now()));
            closeModal();
          }
        });
      }

      // Optional: if Google Form redirects back, auto-dismiss next visit
      if (document.referrer && document.referrer.includes('docs.google.com/forms')) {
        safeSet(MODAL_KEY, '1');
        safeSet(MODAL_LAST, String(Date.now()));
      }
    })();
  </script>

  <!-- Back to top button -->
  <button
    id="back-to-top"
    class="back-to-top"
    type="button"
    aria-label="Back to top"
    aria-hidden="true"
    tabindex="-1"
  >
    ↑ Back to top
  </button>
</body>
</html>
