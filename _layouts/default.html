<!DOCTYPE html>
<html lang="{{ page.lang | default: 'en' }}"{% if page.lang == 'ar' %} dir="rtl"{% endif %}>
<head>
  <meta charset="UTF-8">
  <title>{{ page.title }} | {{ site.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="{{ page.description | default: site.description }}">
  {%- include custom-head.html -%}
  {%- seo -%}
  <link rel="stylesheet" href="{{ "/assets/css/style.css" | relative_url }}">
</head>
<body>
  <a class="skip-link" href="#main-content">Skip to content</a>
  <a class="skip-link" href="#primary-nav">Skip to navigation</a>
  <a class="skip-link" href="#site-footer">Skip to footer</a>
  <header>
    <!-- Brand: clicking this takes you home -->
    <div class="brand header-bar">
      <a class="site-brand" href="{{ '/' | relative_url }}" aria-label="{{ site.title }} home">
        <img src="{{ '/assets/empowrapp-logo.png' | relative_url }}" alt="" width="28" height="28" aria-hidden="true" />
        <span>{{ site.title }}</span>
      </a>
      <button class="menu-toggle" type="button" aria-controls="primary-nav" aria-expanded="false">Menu</button>
  {%- assign current = page.url | default: '/' -%}
  {%- assign lang_code = page.lang | default: 'en' -%}
  {%- assign switch_to = site.data.locales[lang_code].switch_href -%}
  {%- if current == '/about/' -%}{% assign switch_to = '/fr/about/' %}{%- endif -%}
  {%- if current == '/fr/about/' -%}{% assign switch_to = '/about/' %}{%- endif -%}
  {%- if current == '/features/' -%}{% assign switch_to = '/fr/features/' %}{%- endif -%}
  {%- if current == '/fr/features/' -%}{% assign switch_to = '/features/' %}{%- endif -%}
  {%- if current == '/user-guide/' -%}{% assign switch_to = '/fr/user-guide/' %}{%- endif -%}
  {%- if current == '/fr/user-guide/' -%}{% assign switch_to = '/user-guide/' %}{%- endif -%}
  <a class="lang-switch" href="{{ switch_to | relative_url }}">{{ site.data.locales[lang_code].switch_label }}</a>
    </div>

  <nav id="primary-nav" aria-label="Primary">
      {% if page.lang == 'fr' %}{% assign lang_prefix = '/fr' %}{% else %}{% assign lang_prefix = '' %}{% endif %}
      <ul class="nav-list">
        <li>
          <a href="{{ lang_prefix | append: '/' | relative_url }}" {% if page.url == '/' or page.url == '/index.html' or page.url == '/fr/' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Accueil{% else %}Home{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/about' | relative_url }}" {% if page.url contains '/about' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}À propos{% else %}About{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/features' | relative_url }}" {% if page.url contains '/features' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Fonctionnalités{% else %}Features{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/user-guide' | relative_url }}" {% if page.url contains '/user-guide' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Guide d’utilisation{% else %}User Guide{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/contact' | relative_url }}" {% if page.url contains '/contact' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Contact{% else %}Contact{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/blog' | relative_url }}" {% if page.url contains '/blog' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Blog{% else %}Blog{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/newsletter' | relative_url }}" {% if page.url contains '/newsletter' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Infolettre{% else %}Newsletter{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/whats-new' | relative_url }}" {% if page.url contains '/whats-new' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Quoi de neuf{% else %}What's New{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/beta' | relative_url }}" {% if page.url contains '/beta' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Bêta{% else %}Beta Test{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/search' | relative_url }}" {% if page.url contains '/search' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Recherche{% else %}Search{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/events' | relative_url }}" {% if page.url contains '/events' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Événements{% else %}Events{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/site-map' | relative_url }}" {% if page.url contains '/site-map' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Plan du site{% else %}Site Map{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/faq' | relative_url }}" {% if page.url contains '/faq' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}FAQ{% else %}FAQ{% endif %}
          </a>
        </li>
        <li>
          <a href="{{ lang_prefix | append: '/accessibility-settings' | relative_url }}" {% if page.url contains '/accessibility-settings' %}aria-current="page"{% endif %}>
            {% if page.lang == 'fr' %}Paramètres d’accessibilité{% else %}Accessibility Settings{% endif %}
          </a>
        </li>
      </ul>
    </nav>

    <!-- High contrast + Dark mode toggles -->
    <div class="header-controls" role="group" aria-label="Display settings">
      <button
        id="contrast-toggle"
        class="contrast-toggle"
        type="button"
        aria-pressed="false"
        aria-label="Toggle high contrast mode"
      >
        High contrast
      </button>

      <button
        id="theme-toggle"
        class="theme-toggle"
        type="button"
        aria-pressed="false"
        aria-label="Toggle dark mode"
      >
        Dark mode
      </button>
    </div>
  </header>

  {%- comment -%}
    Accessible breadcrumbs. Shows Home > Section > Page when the URL depth >= 2.
    Adjusts based on the current page URL segments.
  {%- endcomment -%}
  <nav aria-label="Breadcrumb" class="breadcrumbs">
    <ol>
      <li><a href="{{ '/' | relative_url }}">Home</a></li>
      {%- assign segments = page.url | split: '/' | where_exp: 's', 's != ""' -%}
      {%- if segments.size > 0 -%}
        {%- assign path = '' -%}
        {%- for seg in segments -%}
          {%- if seg == '' -%}{% continue %}{%- endif -%}
          {%- assign path = path | append: '/' | append: seg -%}
          {%- if forloop.last -%}
            <li aria-current="page">{{ page.title | default: seg | replace: '-', ' ' | capitalize }}</li>
          {%- else -%}
            {%- assign seg_label = seg | replace: '-', ' ' | capitalize -%}
            {%- if seg_label == '' -%}{% assign seg_label = 'Home' %}{%- endif -%}
            <li><a href="{{ path | relative_url }}">{{ seg_label }}</a></li>
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    </ol>
  </nav>

  <main id="main-content" role="main" tabindex="-1">
    {{ content }}
  </main>

  <footer id="site-footer" role="contentinfo">
    <div class="social-links">
      <a href="https://www.facebook.com/3mpowrapp/" target="_blank" rel="noopener noreferrer">Facebook</a>
      <a href="https://x.com/3mpowrapp0816" target="_blank" rel="noopener noreferrer">X (Twitter)</a>
      <a href="https://www.instagram.com/3mpwrapp/" target="_blank" rel="noopener noreferrer">Instagram</a>
      <a href="https://www.youtube.com/3mpwrApp" target="_blank" rel="noopener noreferrer">YouTube</a>
      <a href="{{ '/feed.xml' | relative_url }}" rel="alternate" type="application/rss+xml" aria-label="Subscribe to RSS feed">RSS</a>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLScY599ZYJtpRakd421ADGZumejk2WjmbVvpUknw2uHAzTNx9A/viewform?usp=header" target="_blank" rel="noopener noreferrer">Beta Testers Sign Up</a>
    </div>
  <p>&copy; {{ site.time | date: '%Y' }} <a href="{{ '/' | relative_url }}">3mpowr App</a> • <a href="{{ '/user-guide/' | relative_url }}">User Guide</a> • <a href="{{ '/privacy/' | relative_url }}">Privacy</a> • <a href="{{ '/terms/' | relative_url }}">Terms</a> • <a href="{{ '/cookies/' | relative_url }}">Cookies</a> • <a href="{{ '/faq/' | relative_url }}">FAQ</a> • <a href="{{ '/accessibility' | relative_url }}">Accessibility</a> • <a href="{{ '/accessibility-settings/' | relative_url }}">Accessibility Settings</a> • <a href="{{ '/site-map/' | relative_url }}">Site Map</a> • <a href="{{ '/whats-new/feed.xml' | relative_url }}" rel="alternate" type="application/rss+xml" aria-label="What's New RSS feed">What’s New RSS</a></p>
  <p><strong>Contact:</strong> <a href="mailto:empowrapp08162025@gmail.com">empowrapp08162025@gmail.com</a> • <strong>Company:</strong> 3mpowr App — Canada</p>
  </footer>

  <!-- A11y: skip link should move focus to main -->
  <script>
    (function() {
      // Make all skip links move focus to their target
      function focusTarget(target) {
        if (!target) return;
        // Ensure it can be programmatically focused
        if (!target.hasAttribute('tabindex')) target.setAttribute('tabindex', '-1');
        setTimeout(function(){ try { target.focus(); } catch(e) {} }, 0);
      }
      var links = document.querySelectorAll('.skip-link[href^="#"]');
      links.forEach(function(link){
        link.addEventListener('click', function(e){
          var id = link.getAttribute('href').slice(1);
          var target = document.getElementById(id);
          if (target) { focusTarget(target); }
        });
      });
    })();
  </script>

  <!-- Utilities and controls -->
  <script src="{{ '/assets/js/a11y.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/contrast.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/theme.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/back-to-top.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/settings.js' | relative_url }}" defer></script>

  <script>
    // Mobile menu toggle accessibility
    (function(){
      var toggle = document.querySelector('.menu-toggle');
      var nav = document.getElementById('primary-nav');
      if (!toggle || !nav) return;
      function setOpen(open){
        nav.classList.toggle('is-open', !!open);
        toggle.setAttribute('aria-expanded', !!open);
        if (open) {
          // Move focus to first nav link
          var first = nav.querySelector('a, button, [tabindex]:not([tabindex="-1"])');
          if (first && first.focus) first.focus();
        } else {
          // Return focus to toggle
          if (toggle && toggle.focus) toggle.focus();
        }
      }
      toggle.addEventListener('click', function(){
        var open = nav.classList.contains('is-open');
        setOpen(!open);
      });
      // Close on ESC when open
      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape' && nav.classList.contains('is-open')) setOpen(false);
      });
      // Focus trap within nav when open
      document.addEventListener('keydown', function(e){
        if (!nav.classList.contains('is-open') || e.key !== 'Tab') return;
        var focusables = nav.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');
        focusables = Array.prototype.filter.call(focusables, function(el){ return el.offsetParent !== null; });
        if (focusables.length === 0) return;
        var first = focusables[0];
        var last = focusables[focusables.length - 1];
        var active = document.activeElement;
        if (e.shiftKey && (active === first || !nav.contains(active))) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && (active === last || !nav.contains(active))) {
          e.preventDefault();
          first.focus();
        }
      });
      // Close on click outside
      document.addEventListener('click', function(e){
        if (!nav.classList.contains('is-open')) return;
        var within = nav.contains(e.target) || toggle.contains(e.target);
        if (!within) setOpen(false);
      });
    })();
  </script>

  <!-- Cookie consent banner -->
  <div id="cookie-banner" class="cookie-banner" hidden>
    <p>We use cookies to improve your experience. <a href="{{ '/cookies/' | relative_url }}">Learn more</a>.</p>
    <div class="cookie-actions">
      <button id="cookie-accept" type="button" class="button button--primary">Accept</button>
      <button id="cookie-decline" type="button" class="button button--secondary">Decline</button>
    </div>
  </div>
  <script>
    (function(){
      var KEY = 'cookie-consent';
      function get(k){ try { return localStorage.getItem(k); } catch(e){ return null; } }
      function set(k,v){ try { localStorage.setItem(k,v); } catch(e){} }
      var banner = document.getElementById('cookie-banner');
      var accept = document.getElementById('cookie-accept');
      var decline = document.getElementById('cookie-decline');
      if (!banner || !accept || !decline) return;
      if (!get(KEY)) { banner.hidden = false; }
      function emit(status){ try { window.dispatchEvent(new CustomEvent('cookie-consent', { detail: status })); } catch(e){} }
      accept.addEventListener('click', function(){ set(KEY, 'accepted'); banner.hidden = true; emit('accepted'); });
      decline.addEventListener('click', function(){ set(KEY, 'declined'); banner.hidden = true; emit('declined'); });
    })();
  </script>

  <!-- Newsletter modal (homepage only) -->
  <div id="newsletter-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="newsletter-title" hidden>
    <div class="modal-dialog newsletter-dialog" data-newsletter-dialog>
      <div class="modal-header">
        <h2 id="newsletter-title">Subscribe to our newsletter</h2>
        <div class="modal-actions">
          <a class="modal-link" href="https://docs.google.com/forms/d/e/1FAIpQLSfuItjmtWlUW3L8irmSe8QN129_GJDLAF4f5n-QHPcj_FFoyg/viewform" target="_blank" rel="noopener noreferrer">Open form in new tab</a>
          <button id="newsletter-close" data-action="newsletter-close" type="button" aria-label="Close" class="modal-close">×</button>
        </div>
      </div>
      <div class="modal-body">
        <iframe
          title="3mpowrApp Newsletter Signup"
          src="https://docs.google.com/forms/d/e/1FAIpQLSfuItjmtWlUW3L8irmSe8QN129_GJDLAF4f5n-QHPcj_FFoyg/viewform?embedded=true"
          class="modal-iframe"
          loading="lazy"
        >Loading…</iframe>
      </div>
      <div class="modal-footer">
        <label style="display:flex;align-items:center;gap:0.5rem;">
          <input type="checkbox" id="newsletter-dontshow" />
          Don’t show again
        </label>
        <div class="modal-buttons">
          <button id="newsletter-dismiss" data-action="newsletter-dismiss" type="button" class="button button--secondary">Not now</button>
          <button id="newsletter-subscribed" data-action="newsletter-subscribed" type="button" class="button">Already subscribed</button>
          <button id="newsletter-done" data-action="newsletter-done" type="button" class="button button--primary">Done, go home</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
  var MODAL_KEY = 'newsletter-dismissed'; // legacy key (kept for compatibility)
  var MODAL_SEEN = 'newsletter-seen'; // first-visit gating
  var MODAL_SUB = 'newsletter-subscribed';
  var modal = document.getElementById('newsletter-modal');
  var closeBtn = document.getElementById('newsletter-close');
  var dismissBtn = document.getElementById('newsletter-dismiss');
  var subscribedBtn = document.getElementById('newsletter-subscribed');
  var dialog = modal ? modal.querySelector('[data-newsletter-dialog]') : null;
  var dontShow = document.getElementById('newsletter-dontshow');
  var homeRoot = '{{ '/' | relative_url }}';
      var isHome = (location.pathname === homeRoot || location.pathname === homeRoot + 'index.html');
  var noModal = (new URLSearchParams(location.search)).get('no-modal') === '1';

      function safeSet(key, val) {
        try { localStorage.setItem(key, val); } catch (e) { /* ignore */ }
      }
      function safeGet(key) {
        try { return localStorage.getItem(key); } catch (e) { return null; }
      }

      function closeModal() {
        if (!modal) return;
        modal.hidden = true;
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');
        if (window.announce) {
          window.announce('Newsletter dialog closed');
        }
      }

      function openModal() {
        if (!modal) return;
        modal.hidden = false;
        modal.classList.add('is-open');
        modal.removeAttribute('aria-hidden');
        document.body.classList.add('no-scroll');
        // Focus the dialog for a11y
        if (dialog && dialog.focus) dialog.setAttribute('tabindex','-1'), dialog.focus();
        if (window.announce) {
          window.announce('Newsletter dialog opened');
        }
      }

      function shouldShow() {
        if (safeGet(MODAL_SUB) === '1') return false; // already subscribed
        if (safeGet(MODAL_SEEN) === '1') return false; // first-visit only
        return true;
      }

      if (modal && isHome && !noModal && shouldShow()) {
        // Show after a tiny delay so content is visible behind
        setTimeout(openModal, 400);
      }

      function handleDismiss() {
        safeSet(MODAL_KEY, '1'); // legacy
        if (dontShow && dontShow.checked) {
          safeSet(MODAL_SEEN, '1');
        }
        closeModal();
      }

  [closeBtn, dismissBtn].forEach(function(btn){ if (btn) btn.addEventListener('click', handleDismiss); });

      var doneBtn = document.getElementById('newsletter-done');
      if (doneBtn) {
        doneBtn.addEventListener('click', function(){
          handleDismiss();
          safeSet(MODAL_SEEN, '1');
          // Ensure we land on home
          try { window.location.assign(homeRoot); } catch(e) {}
        });
      }

      if (subscribedBtn) {
        subscribedBtn.addEventListener('click', function(){
          safeSet(MODAL_SUB, '1');
          safeSet(MODAL_SEEN, '1');
          closeModal();
        });
      }

      // Delegated click handling using data-action for broader compatibility
      document.addEventListener('click', function(e){
        var t = e.target;
        if (!t) return;
        var action = t.getAttribute && t.getAttribute('data-action');
        if (!action && t.closest) {
          var closest = t.closest('[data-action]');
          if (closest) action = closest.getAttribute('data-action');
        }
        if (!action) return;
        if (action === 'newsletter-close' || action === 'newsletter-dismiss') {
          handleDismiss();
        } else if (action === 'newsletter-subscribed') {
          safeSet(MODAL_SUB, '1');
          safeSet(MODAL_SEEN, '1');
          closeModal();
        } else if (action === 'newsletter-done') {
          handleDismiss();
          try { window.location.assign(homeRoot); } catch(e) {}
        }
      }, true);

      // Close on ESC and trap focus while open
      document.addEventListener('keydown', function(e){
        if (!modal || modal.hidden) return;
        if (e.key === 'Escape') {
          safeSet(MODAL_KEY, '1');
          if (dontShow && dontShow.checked) safeSet(MODAL_SEEN, '1');
          closeModal();
          return;
        }
        if (e.key === 'Tab') {
          var focusables = dialog ? dialog.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])') : [];
          focusables = Array.prototype.slice.call(focusables).filter(function(el){ return el.offsetParent !== null; });
          if (focusables.length === 0) return;
          var first = focusables[0];
          var last = focusables[focusables.length - 1];
          var active = document.activeElement;
          if (e.shiftKey) {
            if (active === first || !dialog.contains(active)) {
              e.preventDefault();
              last.focus();
            }
          } else {
            if (active === last || !dialog.contains(active)) {
              e.preventDefault();
              first.focus();
            }
          }
        }
      }, true);

      // Close on backdrop click (but not when clicking inside dialog)
      if (modal) {
        modal.addEventListener('click', function(e){
          if (e.target === modal) {
            safeSet(MODAL_KEY, '1');
            if (dontShow && dontShow.checked) safeSet(MODAL_SEEN, '1');
            closeModal();
          }
        });
      }

      // Optional: if Google Form redirects back, auto-dismiss next visit
      if (document.referrer && document.referrer.includes('docs.google.com/forms')) {
        safeSet(MODAL_KEY, '1');
        safeSet(MODAL_SEEN, '1');
      }
    })();
  </script>

  <!-- Back to top button -->
  <button
    id="back-to-top"
    class="back-to-top"
    type="button"
    aria-label="Back to top"
    aria-hidden="true"
    tabindex="-1"
  >
    ↑ Back to top
  </button>
</body>
</html>
