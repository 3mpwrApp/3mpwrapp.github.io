name: Trending Keywords Update

# Update trending keywords and social trends between curation runs
# Runs every 6 hours to stay current with disability movement

on:
  schedule:
    # Every 6 hours - offset from main curator
    - cron: '0 0,6,12,18 * * *'
    
  workflow_dispatch:
    inputs:
      track_social:
        description: 'Track social media trends'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  update_trends:
    name: Update Trending Keywords
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Track social media trends
        if: github.event.inputs.track_social != 'false'
        env:
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
          BLUESKY_PDS: 'https://bsky.social'
        run: |
          echo "🔍 Tracking social media trends..."
          node scripts/curator-social-trends.js || echo "⚠️ Social tracking failed"

      - name: Apply time decay to trending keywords
        run: |
          echo "⏰ Applying time decay to trending keywords..."
          node -e "
          const TrendingTopics = require('./scripts/curator-trending.js');
          const trending = new TrendingTopics();
          trending.applyTimeDecay();
          trending.save();
          console.log('✅ Time decay applied');
          " || echo "⚠️ Time decay failed"

      - name: Commit trend updates
        run: |
          git config --local user.email "empowrapp08162025@gmail.com"
          git config --local user.name "3mpwrApp Trends Bot"
          
          git add public/trending-topics.json public/social-trends.json || true
          
          if git diff --staged --quiet; then
            echo "✅ No trend changes to commit"
            exit 0
          fi
          
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "chore(trends): Update trending keywords - $TIMESTAMP"
          git push origin main || echo "⚠️ No changes to push"

      - name: Create summary
        if: always()
        run: |
          echo "# 📈 Trending Keywords Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "public/social-trends.json" ]; then
            echo "**Social Trends:**" >> $GITHUB_STEP_SUMMARY
            jq -r '.emergingTopics[0:5][] | "• \(.keyword) (\(.count) mentions)"' public/social-trends.json 2>/dev/null >> $GITHUB_STEP_SUMMARY || true
          fi
