{%- comment -%}
This file is injected by Minima's head.html if present.
We add favicons, webmanifest, and optional GA4 (via analytics.html).
{%- endcomment -%}

{%- comment -%} Canonical URL: Always point to Cloudflare Pages as primary {%- endcomment -%}
<link rel="canonical" href="{{ page.url | replace:'index.html','' | absolute_url }}">

{%- comment -%} Microsoft Clarity - Privacy-friendly analytics (free, unlimited) {%- endcomment -%}
{% if jekyll.environment == 'production' %}
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "tps3d4cg0x");
</script>
{% endif %}

{%- comment -%} Performance: DNS prefetch and preconnect for external resources {%- endcomment -%}
<link rel="dns-prefetch" href="//www.clarity.ms">
<link rel="preconnect" href="https://www.clarity.ms" crossorigin>
{%- if site.ga_measurement_id -%}
<link rel="dns-prefetch" href="//www.googletagmanager.com">
<link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
{%- endif -%}
{%- if site.analytics_provider == 'goatcounter' -%}
<link rel="dns-prefetch" href="//gc.zgo.at">
<link rel="preconnect" href="https://gc.zgo.at" crossorigin>
{%- endif -%}

{%- comment -%} Performance: Preload critical CSS {%- endcomment -%}
<link rel="preload" href="{{ '/assets/css/style.css' | relative_url }}" as="style">

{%- comment -%} Favicon & PWA {%- endcomment -%}
{%- if site.favicon and site.favicon != '' -%}
<link rel="icon" href="{{ site.favicon | relative_url }}" type="image/svg+xml">
{%- endif -%}

{%- if site.apple_touch_icon and site.apple_touch_icon != '' -%}
<link rel="apple-touch-icon" sizes="180x180" href="{{ site.apple_touch_icon | relative_url }}">
{%- endif -%}

{%- if site.webmanifest and site.webmanifest != '' -%}
<link rel="manifest" href="{{ site.webmanifest | relative_url }}">
{%- endif -%}

<meta name="theme-color" content="#111111">
<meta name="color-scheme" content="light dark">
<meta name="fediverse:creator" content="@3mpwrApp@mastodon.social">

<!-- What's New RSS feed autodiscovery -->
<link rel="alternate" type="application/rss+xml" title="{{ site.title }} — What's New" href="{{ '/whats-new/feed.xml' | relative_url }}">

<!-- Main site RSS feed autodiscovery -->
<link rel="alternate" type="application/rss+xml" title="{{ site.title }} — Site Feed" href="{{ '/feed.xml' | relative_url }}">

{%- comment -%} Internationalization: hreflang alternates {%- endcomment -%}
<link rel="alternate" hreflang="en" href="{{ '/' | absolute_url }}">
<link rel="alternate" hreflang="fr" href="{{ '/fr/' | absolute_url }}">
<link rel="alternate" hreflang="es" href="{{ '/es/' | absolute_url }}">
<link rel="alternate" hreflang="ar" href="{{ '/ar/' | absolute_url }}">
<link rel="alternate" hreflang="zh" href="{{ '/zh/' | absolute_url }}">
<link rel="alternate" hreflang="pa" href="{{ '/pa/' | absolute_url }}">
<link rel="alternate" hreflang="x-default" href="{{ '/' | absolute_url }}">
{%- comment -%}
Per-page alternates for About, Features, and User Guide
{%- endcomment -%}
{%- if page.url == '/about/' or page.url == '/fr/about/' -%}
  <link rel="alternate" hreflang="en" href="{{ '/about/' | absolute_url }}">
  <link rel="alternate" hreflang="fr" href="{{ '/fr/about/' | absolute_url }}">
{%- endif -%}
{%- if page.url == '/features/' or page.url == '/fr/features/' -%}
  <link rel="alternate" hreflang="en" href="{{ '/features/' | absolute_url }}">
  <link rel="alternate" hreflang="fr" href="{{ '/fr/features/' | absolute_url }}">
{%- endif -%}
{%- if page.url == '/user-guide/' or page.url == '/fr/user-guide/' -%}
  <link rel="alternate" hreflang="en" href="{{ '/user-guide/' | absolute_url }}">
  <link rel="alternate" hreflang="fr" href="{{ '/fr/user-guide/' | absolute_url }}">
{%- endif -%}

{%- comment -%}
Consent-gated analytics loader
Supports:
- Google Analytics 4 (if site.ga_measurement_id is set and analytics_provider is empty)
- GoatCounter (if site.analytics_provider == 'goatcounter' and site.goatcounter_domain is set)
{%- endcomment -%}
<script>
(function(){
  var KEY = 'cookie-consent';
  function get(k){ try { return localStorage.getItem(k); } catch(e){ return null; } }
  function onConsent(cb){
    if (get(KEY) === 'accepted') { cb(); return; }
    window.addEventListener('cookie-consent', function(e){ if (e && e.detail === 'accepted') cb(); });
  }

  // Google Analytics 4
  var useGA = ("{{ site.ga_measurement_id | default: '' | strip }}" !== "") && ("{{ site.analytics_provider | default: '' | strip }}" === "");
  if (useGA) {
    onConsent(function(){
      if (window.__gaLoaded) return; window.__gaLoaded = true;
      var s = document.createElement('script');
      s.async = true;
      s.src = 'https://www.googletagmanager.com/gtag/js?id={{ site.ga_measurement_id | escape }}';
      s.crossOrigin = 'anonymous';
      s.onerror = function(){
        console.warn('Google Analytics script blocked or failed to load. Ad blockers or privacy extensions may be active.');
        window.__gaLoadError = true;
      };
      document.head.appendChild(s);
      window.dataLayer = window.dataLayer || [];
      function gtag(){ 
        if (!window.__gaLoadError) {
          dataLayer.push(arguments); 
        }
      }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', '{{ site.ga_measurement_id | escape }}', {
        'anonymize_ip': true,
        'cookie_flags': 'SameSite=Strict;Secure',
        'cookie_expires': 63072000,
        'cookie_update': false,
        'allow_ad_personalization_signals': false,
        'allow_google_signals': false
      });
    });
  }

  // GoatCounter (privacy-friendly, free)
  var useGoat = ("{{ site.analytics_provider | default: '' | strip }}" === "goatcounter") && ("{{ site.goatcounter_domain | default: '' | strip }}" !== "");
  if (useGoat) {
    onConsent(function(){
      if (window.__goatLoaded) return; window.__goatLoaded = true;
      var s = document.createElement('script');
      s.async = true;
      s.setAttribute('data-goatcounter', 'https://{{ site.goatcounter_domain | escape }}.goatcounter.com/count');
      s.src = 'https://gc.zgo.at/count.js';
      s.crossOrigin = 'anonymous';
      s.onerror = function(){
        console.warn('GoatCounter analytics unavailable. Connection may be blocked.');
      };
      document.head.appendChild(s);
    });
  }
})();
</script>

{%- comment -%} JSON-LD: Organization schema {%- endcomment -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "{{ site.title | escape }}",
  "url": "{{ site.url | append: site.baseurl }}",
  "logo": "{{ site.logo | default: site.favicon | relative_url | absolute_url }}",
  "sameAs": [{% for link in site.social.links %}"{{ link }}"{% if forloop.last == false %}, {% endif %}{% endfor %}]
}
</script>

{%- comment -%} JSON-LD: BreadcrumbList for deep pages {%- endcomment -%}
{%- assign segments = page.url | split: '/' | where_exp: 's', 's != ""' -%}
{%- if segments.size > 0 -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "{{ '/' | absolute_url }}"
    }
    {%- assign path = '' -%}
    {%- for seg in segments -%}
      {%- if seg == '' -%}{% continue %}{%- endif -%}
      {%- assign path = path | append: '/' | append: seg -%}
      ,{
        "@type": "ListItem",
        "position": {{ forloop.index | plus: 1 }},
        "name": "{{ seg | replace: '-', ' ' | capitalize }}",
        "item": "{{ path | absolute_url }}"
      }
    {%- endfor -%}
  ]
}
</script>
{%- endif -%}
